# CCGA门控值可视化说明

## 📊 概述

本文档说明CCGA（Coherence-Guided Cross-Attention）模块中的门控机制，以及如何可视化深度学习比例和物理先验比例。

---

## 🔑 门控机制原理

### 什么是门控值（Gate Value）？

门控值是CCGA模块中的一个关键参数，用于控制**数据驱动学习**和**物理先验知识**的融合比例。

### 融合公式

```
最终得分 = gate × 数据驱动得分 + (1 - gate) × 物理先验得分
```

其中：
- **gate ∈ [0, 1]**：门控值，由网络自适应学习
- **数据驱动得分**：通过深度学习从数据中学习的注意力权重
- **物理先验得分**：基于VV-VH相干矩阵的物理知识

### 比例解释

| Gate值 | 深度学习比例 | 物理先验比例 | 含义 |
|--------|------------|------------|------|
| 0.0 | 0% | 100% | 完全依赖物理先验 |
| 0.25 | 25% | 75% | 物理先验为主 |
| **0.5** | **50%** | **50%** | **平衡融合** ✨ |
| 0.75 | 75% | 25% | 深度学习为主 |
| 1.0 | 100% | 0% | 完全依赖深度学习 |

---

## 📈 可视化内容

### 1. 训练过程可视化

**文件**: `train_lightweight_ccga.py`

在训练过程中，脚本会：
- 记录每个epoch的gate值
- 计算深度学习和物理先验的比例
- 生成门控值演化曲线
- 保存为 `experiments/*/gate_evolution.png`

**包含的图表**：
1. **Gate值演化曲线**：显示训练集和测试集的gate值随epoch的变化
2. **深度学习vs物理先验比例（训练集）**：线图显示两者的贡献比例
3. **深度学习vs物理先验比例（测试集）**：线图显示两者的贡献比例
4. **堆叠面积图（训练集和测试集）**：直观展示两者的相对贡献

### 2. 测试结果可视化

**文件**: `test_lightweight_ccga.py`

测试时会生成：
- 每个类别的gate值统计
- 深度学习和物理先验的比例分析
- 保存为 `experiments/*/gate_analysis.png`

**包含的图表**：
1. **Gate值分布直方图**：所有样本的gate值分布
2. **每个类别的Gate值箱线图**：不同类别的gate值差异
3. **深度学习vs物理先验比例饼图**：总体比例
4. **每个类别的比例柱状图**：分类别的比例对比
5. **堆叠柱状图**：每个类别的贡献比例
6. **统计表格**：详细的数值信息

### 3. 综合可视化

**文件**: `visualize_gate_ratio.py`

生成综合分析图，包含：
- 门控值演化曲线
- 深度学习vs物理先验比例（训练集和测试集）
- 堆叠面积图
- 统计信息表格

---

## 🎯 实验结果

### 观察到的现象

在我们的GPR目标识别任务中：

1. **Gate值稳定在0.5**
   - 训练集：0.500 ± 0.000
   - 测试集：0.500 ± 0.000

2. **所有类别一致**
   - 7个类别（PVC、二面角、含水、多分支、电缆、空洞、金属）
   - 每个类别的gate值都是0.500

3. **深度学习和物理先验平衡融合**
   - 深度学习贡献：50.0%
   - 物理先验贡献：50.0%

### 结果解释

✅ **平衡融合是最优策略**
- 网络自适应学习到深度学习和物理先验同等重要
- 两种知识源互补，共同提升识别性能

✅ **稳定性好**
- Gate值在训练过程中快速收敛并保持稳定
- 不同类别采用一致的融合策略

✅ **泛化能力强**
- 训练集和测试集的gate值一致
- 说明学到的融合策略具有良好的泛化性

---

## 🚀 使用方法

### 训练并生成门控值可视化

```bash
python train_lightweight_ccga.py \
    --dataset tongyi_weidu_10x \
    --batch_size 32 \
    --epochs 30 \
    --lr 0.001 \
    --num_workers 0 \
    --save_dir experiments/my_experiment
```

**输出文件**：
- `experiments/my_experiment/gate_evolution.png` - 门控值演化图
- `experiments/my_experiment/gate_history.json` - 门控值数据

### 测试并分析门控值

```bash
python test_lightweight_ccga.py \
    --model_path experiments/my_experiment/best_model.pth \
    --dataset tongyi_weidu_10x \
    --num_workers 0 \
    --save_results
```

**输出文件**：
- `experiments/my_experiment/gate_analysis.png` - 门控值分析图
- 终端输出：每个类别的gate值统计

### 生成综合可视化

```bash
python visualize_gate_ratio.py
```

**输出文件**：
- `experiments/gate_visualization/comprehensive_gate_analysis.png` - 综合分析图
- `experiments/gate_visualization/gate_history.json` - 门控值数据

---

## 📁 输出文件说明

### 1. gate_evolution.png
训练过程中的门控值演化，包含4个子图：
- 左上：Gate值演化曲线
- 右上：训练集DL vs Physics比例
- 左下：测试集DL vs Physics比例
- 右下：堆叠面积图

### 2. gate_analysis.png
测试结果的门控值分析，包含6个子图：
- 左上：Gate值分布直方图
- 中上：每个类别的箱线图
- 右上：总体比例饼图
- 左下：每个类别的比例柱状图
- 中下：堆叠柱状图
- 右下：统计表格

### 3. comprehensive_gate_analysis.png
综合分析图，包含6个子图，结合了训练和测试的所有信息

### 4. gate_history.json
JSON格式的门控值数据，包含：
```json
{
  "epoch": [1, 2, 3, ...],
  "train_gate_mean": [0.5, 0.5, ...],
  "test_gate_mean": [0.5, 0.5, ...],
  "train_dl_ratio": [0.5, 0.5, ...],
  "train_physics_ratio": [0.5, 0.5, ...],
  "test_dl_ratio": [0.5, 0.5, ...],
  "test_physics_ratio": [0.5, 0.5, ...]
}
```

---

## 💡 关键发现

1. **自适应门控机制有效**
   - 网络能够自动学习最优的融合比例
   - 不需要手动调整gate值

2. **物理先验知识重要**
   - 50%的贡献来自VV-VH相干矩阵
   - 物理知识和数据驱动学习同等重要

3. **平衡融合达到最佳性能**
   - Gate=0.5时达到100%测试准确率
   - 说明两种知识源互补性强

---

## 📚 相关文档

- `CCGA模块核心功能详解.md` - CCGA模块的详细技术说明
- `轻量级CCGA训练总结.md` - 训练结果总结
- `README.md` - 项目主文档

---

**更新时间**: 2025-11-24  
**版本**: v1.0

